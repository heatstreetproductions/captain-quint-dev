//@version=6
indicator("Advanced Volume Profile", overlay=true, max_bars_back=5000, max_lines_count=500, max_boxes_count=500)

// ==================== INPUTS ====================
// Profile Settings
profileType = input.string("Fixed Range", "Profile Type", options=["Fixed Range", "Session", "Auto Anchored"], group="Profile Settings")
lookbackPeriod = input.int(100, "Lookback Period (bars)", minval=10, group="Profile Settings")
numRows = input.int(24, "Number of Rows", minval=5, maxval=100, group="Profile Settings")
valueAreaPercent = input.float(70.0, "Value Area %", minval=50, maxval=100, step=5, group="Profile Settings")

// Visual Settings
showPOC = input.bool(true, "Show POC (Point of Control)", group="Visual Settings")
showVAH = input.bool(true, "Show VAH (Value Area High)", group="Visual Settings")
showVAL = input.bool(true, "Show VAL (Value Area Low)", group="Visual Settings")
showProfile = input.bool(true, "Show Volume Profile", group="Visual Settings")
profileWidth = input.int(50, "Profile Width", minval=10, maxval=200, group="Visual Settings")
profileOpacity = input.int(70, "Profile Opacity", minval=0, maxval=100, group="Visual Settings")

// Colors
pocColor = input.color(color.new(color.yellow, 0), "POC Color", group="Colors")
vahColor = input.color(color.new(color.blue, 0), "VAH Color", group="Colors")
valColor = input.color(color.new(color.blue, 0), "VAL Color", group="Colors")
profileColorBullish = input.color(color.new(color.green, 30), "Profile Color (Bullish)", group="Colors")
profileColorBearish = input.color(color.new(color.red, 30), "Profile Color (Bearish)", group="Colors")

// Advanced Features
showVolumeText = input.bool(true, "Show Volume Text", group="Advanced")
highlightValueArea = input.bool(true, "Highlight Value Area", group="Advanced")
sessionTime = input.session("0000-2400", "Session Time", group="Advanced")

// ==================== VARIABLES ====================
var box[] profileBoxes = array.new<box>()
var label[] volumeLabels = array.new<label>()
var line[] lines = array.new<line>()
var box[] boxes = array.new<box>()

// ==================== FUNCTIONS ====================

// Clear previous drawings
clearDrawings() =>
    // Clear lines
    if array.size(lines) > 0
        for i = 0 to array.size(lines) - 1
            line.delete(array.get(lines, i))
        array.clear(lines)
    
    // Clear boxes
    if array.size(boxes) > 0
        for i = 0 to array.size(boxes) - 1
            box.delete(array.get(boxes, i))
        array.clear(boxes)
    
    // Clear profile boxes
    if array.size(profileBoxes) > 0
        for i = 0 to array.size(profileBoxes) - 1
            box.delete(array.get(profileBoxes, i))
        array.clear(profileBoxes)
    
    // Clear labels
    if array.size(volumeLabels) > 0
        for i = 0 to array.size(volumeLabels) - 1
            label.delete(array.get(volumeLabels, i))
        array.clear(volumeLabels)

// Calculate volume profile
calculateVolumeProfile() =>
    // Check if we have enough bars
    if bar_index < lookbackPeriod
        [na, na, na, array.new<float>(), na, na, na, na]
    else
        // Get price range
        var float highestPrice = high[0]
        var float lowestPrice = low[0]
        
        for i = 0 to lookbackPeriod - 1
            if high[i] > highestPrice
                highestPrice := high[i]
            if low[i] < lowestPrice
                lowestPrice := low[i]
        
        // Calculate row height
        priceRange = highestPrice - lowestPrice
        
        // Avoid division by zero
        if priceRange == 0
            [na, na, na, array.new<float>(), na, na, na, na]
        else
            rowHeight = priceRange / numRows
            
            // Initialize volume array
            volumeArray = array.new<float>(numRows, 0.0)
            
            // Accumulate volume in each price row
            for i = 0 to lookbackPeriod - 1
                if not na(high[i]) and not na(low[i]) and not na(volume[i])
                    barHigh = high[i]
                    barLow = low[i]
                    barVolume = volume[i]
                    
                    // Determine which rows this bar touches
                    startRow = math.floor((barLow - lowestPrice) / rowHeight)
                    endRow = math.floor((barHigh - lowestPrice) / rowHeight)
                    
                    startRow := math.max(0, math.min(numRows - 1, startRow))
                    endRow := math.max(0, math.min(numRows - 1, endRow))
                    
                    touchedRows = endRow - startRow + 1
                    volumePerRow = barVolume / touchedRows
                    
                    for j = startRow to endRow
                        currentVol = array.get(volumeArray, j)
                        array.set(volumeArray, j, currentVol + volumePerRow)
            
            // Find POC (row with highest volume)
            maxVolume = 0.0
            pocRow = 0
            for i = 0 to numRows - 1
                vol = array.get(volumeArray, i)
                if vol > maxVolume
                    maxVolume := vol
                    pocRow := i
            
            pocPrice = lowestPrice + (pocRow + 0.5) * rowHeight
            
            // Calculate Value Area
            totalVolume = 0.0
            for i = 0 to numRows - 1
                totalVolume := totalVolume + array.get(volumeArray, i)
            
            targetVolume = totalVolume * (valueAreaPercent / 100.0)
            
            // Expand from POC to find value area
            valueAreaVol = array.get(volumeArray, pocRow)
            upperRow = pocRow
            lowerRow = pocRow
            
            while valueAreaVol < targetVolume and (upperRow < numRows - 1 or lowerRow > 0)
                upperVol = upperRow < numRows - 1 ? array.get(volumeArray, upperRow + 1) : 0.0
                lowerVol = lowerRow > 0 ? array.get(volumeArray, lowerRow - 1) : 0.0
                
                if upperVol > lowerVol and upperRow < numRows - 1
                    upperRow := upperRow + 1
                    valueAreaVol := valueAreaVol + upperVol
                else if lowerRow > 0
                    lowerRow := lowerRow - 1
                    valueAreaVol := valueAreaVol + lowerVol
                else if upperRow < numRows - 1
                    upperRow := upperRow + 1
                    valueAreaVol := valueAreaVol + upperVol
                else
                    break
            
            vahPrice = lowestPrice + (upperRow + 1) * rowHeight
            valPrice = lowestPrice + lowerRow * rowHeight
            
            [lowestPrice, highestPrice, rowHeight, volumeArray, pocPrice, vahPrice, valPrice, maxVolume]

// ==================== MAIN LOGIC ====================

if barstate.islast and showProfile and bar_index >= lookbackPeriod
    clearDrawings()
    
    [lowestPrice, highestPrice, rowHeight, volumeArray, pocPrice, vahPrice, valPrice, maxVolume] = calculateVolumeProfile()
    
    // Only proceed if we have valid data
    if not na(pocPrice) and array.size(volumeArray) > 0
        // Draw volume profile
        currentBar = bar_index
        maxWidth = profileWidth
        
        for i = 0 to array.size(volumeArray) - 1
            rowVolume = array.get(volumeArray, i)
            rowBottom = lowestPrice + i * rowHeight
            rowTop = rowBottom + rowHeight
            
            // Calculate width based on volume
            widthRatio = maxVolume > 0 ? rowVolume / maxVolume : 0
            barWidth = math.floor(widthRatio * maxWidth)
            
            if barWidth > 0
                // Determine color based on whether price is above or below POC
                rowMidPrice = (rowBottom + rowTop) / 2
                boxColor = rowMidPrice > pocPrice ? profileColorBullish : profileColorBearish
                
                profileBox = box.new(
                     left=currentBar - barWidth,
                     top=rowTop,
                     right=currentBar,
                     bottom=rowBottom,
                     bgcolor=boxColor,
                     border_color=color.new(boxColor, 0),
                     border_width=1
                 )
                array.push(profileBoxes, profileBox)
                
                // Add volume text
                if showVolumeText and widthRatio > 0.3
                    volumeLabel = label.new(
                         x=currentBar - math.floor(barWidth / 2),
                         y=rowMidPrice,
                         text=str.tostring(math.round(rowVolume)),
                         style=label.style_none,
                         textcolor=color.new(color.white, 0),
                         size=size.tiny
                     )
                    array.push(volumeLabels, volumeLabel)
        
        // Draw POC line
        if showPOC
            pocLine = line.new(
                 x1=currentBar - profileWidth - 10,
                 y1=pocPrice,
                 x2=currentBar + 10,
                 y2=pocPrice,
                 color=pocColor,
                 width=2,
                 style=line.style_solid
             )
            array.push(lines, pocLine)
            
            label.new(
                 x=currentBar + 12,
                 y=pocPrice,
                 text="POC",
                 style=label.style_label_left,
                 color=pocColor,
                 textcolor=color.white,
                 size=size.small
             )
        
        // Draw VAH line
        if showVAH
            vahLine = line.new(
                 x1=currentBar - profileWidth - 10,
                 y1=vahPrice,
                 x2=currentBar + 10,
                 y2=vahPrice,
                 color=vahColor,
                 width=1,
                 style=line.style_dashed
             )
            array.push(lines, vahLine)
            
            label.new(
                 x=currentBar + 12,
                 y=vahPrice,
                 text="VAH",
                 style=label.style_label_left,
                 color=vahColor,
                 textcolor=color.white,
                 size=size.small
             )
        
        // Draw VAL line
        if showVAL
            valLine = line.new(
                 x1=currentBar - profileWidth - 10,
                 y1=valPrice,
                 x2=currentBar + 10,
                 y2=valPrice,
                 color=valColor,
                 width=1,
                 style=line.style_dashed
             )
            array.push(lines, valLine)
            
            label.new(
                 x=currentBar + 12,
                 y=valPrice,
                 text="VAL",
                 style=label.style_label_left,
                 color=valColor,
                 textcolor=color.white,
                 size=size.small
             )
        
        // Highlight value area
        if highlightValueArea
            valueAreaBox = box.new(
                 left=currentBar - profileWidth - 10,
                 top=vahPrice,
                 right=currentBar + 10,
                 bottom=valPrice,
                 bgcolor=color.new(color.blue, 95),
                 border_color=color.new(color.blue, 70),
                 border_width=1,
                 border_style=line.style_dotted
             )
            array.push(boxes, valueAreaBox)

// Plot current price for reference
plot(close, "Current Price", color=color.new(color.gray, 70), linewidth=1)
