//@version=6
indicator("ü¶à Quint Advanced Price Action System", overlay=true, max_bars_back=5000, max_lines_count=500, max_boxes_count=500)

// ==================== INPUTS ====================
// Core Settings
string timeframeGroup = "‚öôÔ∏è Core Settings"
multitimeframe = input.bool(true, "Multi-Timeframe Analysis", group=timeframeGroup)
htf1 = input.timeframe("15", "HTF 1", group=timeframeGroup)
htf2 = input.timeframe("60", "HTF 2", group=timeframeGroup)

// Smart Money Concepts
string smcGroup = "üí∞ Smart Money Concepts"
showOrderBlocks = input.bool(true, "Show Order Blocks", group=smcGroup)
showFVG = input.bool(true, "Show Fair Value Gaps", group=smcGroup)
showLiquidity = input.bool(true, "Show Liquidity Zones", group=smcGroup)
showBOS = input.bool(true, "Show Break of Structure", group=smcGroup)
obPeriod = input.int(20, "Order Block Lookback", minval=5, maxval=100, group=smcGroup)

// Market Structure
string structureGroup = "üìä Market Structure"
swingLength = input.int(10, "Swing Detection Length", minval=5, maxval=50, group=structureGroup)
showStructure = input.bool(true, "Show Market Structure", group=structureGroup)
showSR = input.bool(true, "Show Support/Resistance", group=structureGroup)

// Volume Analysis
string volumeGroup = "üìà Volume Analysis"
showVolumeProfile = input.bool(true, "Show Volume Zones", group=volumeGroup)
volumeThreshold = input.float(1.5, "Volume Spike Threshold", minval=1.0, maxval=5.0, step=0.1, group=volumeGroup)
showDelta = input.bool(true, "Show Buy/Sell Delta", group=volumeGroup)

// Momentum & Trend
string momentumGroup = "‚ö° Momentum Analysis"
showMomentum = input.bool(true, "Show Momentum Signals", group=momentumGroup)
rsiLength = input.int(14, "RSI Length", minval=5, maxval=50, group=momentumGroup)
macdFast = input.int(12, "MACD Fast", minval=5, maxval=50, group=momentumGroup)
macdSlow = input.int(26, "MACD Slow", minval=10, maxval=100, group=momentumGroup)
macdSignal = input.int(9, "MACD Signal", minval=3, maxval=30, group=momentumGroup)

// Advanced Patterns
string patternGroup = "üéØ Pattern Recognition"
showPatterns = input.bool(true, "Show Chart Patterns", group=patternGroup)
showHarmonics = input.bool(true, "Show Harmonic Patterns", group=patternGroup)
showCandles = input.bool(true, "Show Candlestick Patterns", group=patternGroup)

// Signal Settings
string signalGroup = "üé™ Signal Settings"
showBuySignals = input.bool(true, "Show BUY Signals", group=signalGroup)
showSellSignals = input.bool(true, "Show SELL Signals", group=signalGroup)
signalStrength = input.string("Medium", "Minimum Signal Strength", options=["Low", "Medium", "High"], group=signalGroup)
alertOnSignal = input.bool(true, "Enable Alerts", group=signalGroup)

// Visual Settings
string visualGroup = "üé® Visual Settings"
bullColor = input.color(color.new(color.green, 0), "Bullish Color", group=visualGroup)
bearColor = input.color(color.new(color.red, 0), "Bearish Color", group=visualGroup)
obBullColor = input.color(color.new(color.green, 80), "Bull Order Block", group=visualGroup)
obBearColor = input.color(color.new(color.red, 80), "Bear Order Block", group=visualGroup)
fvgBullColor = input.color(color.new(color.aqua, 90), "Bull FVG", group=visualGroup)
fvgBearColor = input.color(color.new(color.orange, 90), "Bear FVG", group=visualGroup)

// ==================== VARIABLES ====================
var box[] orderBlocks = array.new<box>()
var box[] fvgBoxes = array.new<box>()
var line[] structureLines = array.new<line>()
var label[] signalLabels = array.new<label>()
var line[] srLines = array.new<line>()

// ==================== HELPER FUNCTIONS ====================

// Clear old drawings
clearOldDrawings() =>
    if array.size(orderBlocks) > 50
        for i = 0 to math.min(10, array.size(orderBlocks) - 1)
            box.delete(array.shift(orderBlocks))
    
    if array.size(fvgBoxes) > 50
        for i = 0 to math.min(10, array.size(fvgBoxes) - 1)
            box.delete(array.shift(fvgBoxes))

// ==================== MARKET STRUCTURE ====================

// Swing High/Low Detection - FIXED
isSwingHigh(len) =>
    if bar_index < len
        false
    else
        highestInRange = true
        for i = 1 to len
            if high[i] > high or (bar_index >= i and high[i] >= high)
                highestInRange := false
                break
        highestInRange

isSwingLow(len) =>
    if bar_index < len
        false
    else
        lowestInRange = true
        for i = 1 to len
            if low[i] < low or (bar_index >= i and low[i] <= low)
                lowestInRange := false
                break
        lowestInRange

swingHigh = isSwingHigh(swingLength)
swingLow = isSwingLow(swingLength)

// Store swing points
var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = na
var int lastSwingLowBar = na

if swingHigh
    lastSwingHigh := high
    lastSwingHighBar := bar_index

if swingLow
    lastSwingLow := low
    lastSwingLowBar := bar_index

// Break of Structure Detection
var bool bullishBOS = false
var bool bearishBOS = false

if not na(lastSwingHigh) and close > lastSwingHigh
    bullishBOS := true
else
    bullishBOS := false

if not na(lastSwingLow) and close < lastSwingLow
    bearishBOS := true
else
    bearishBOS := false

// Plot structure
plotshape(showStructure and swingHigh, "Swing High", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.tiny)
plotshape(showStructure and swingLow, "Swing Low", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.tiny)

// ==================== ORDER BLOCKS ====================

// Bullish Order Block
detectBullishOB() =>
    obHigh = 0.0
    obLow = 0.0
    obBar = 0
    isValid = false
    
    strongBullish = close > open and (close - open) > (high - low) * 0.6
    
    if strongBullish
        for i = 1 to obPeriod
            if bar_index >= i and close[i] < open[i]
                obHigh := high[i]
                obLow := low[i]
                obBar := bar_index - i
                isValid := true
                break
    
    [obHigh, obLow, obBar, isValid]

// Bearish Order Block
detectBearishOB() =>
    obHigh = 0.0
    obLow = 0.0
    obBar = 0
    isValid = false
    
    strongBearish = close < open and (open - close) > (high - low) * 0.6
    
    if strongBearish
        for i = 1 to obPeriod
            if bar_index >= i and close[i] > open[i]
                obHigh := high[i]
                obLow := low[i]
                obBar := bar_index - i
                isValid := true
                break
    
    [obHigh, obLow, obBar, isValid]

// Draw Order Blocks
if showOrderBlocks and barstate.islast
    [bullOBHigh, bullOBLow, bullOBBar, bullOBValid] = detectBullishOB()
    [bearOBHigh, bearOBLow, bearOBBar, bearOBValid] = detectBearishOB()
    
    if bullOBValid and bar_index - bullOBBar < 50
        bullOB = box.new(bullOBBar, bullOBHigh, bar_index + 10, bullOBLow, 
                         bgcolor=obBullColor, border_color=bullColor, border_width=1,
                         text="Bull OB", text_color=bullColor, text_size=size.small)
        array.push(orderBlocks, bullOB)
    
    if bearOBValid and bar_index - bearOBBar < 50
        bearOB = box.new(bearOBBar, bearOBHigh, bar_index + 10, bearOBLow,
                         bgcolor=obBearColor, border_color=bearColor, border_width=1,
                         text="Bear OB", text_color=bearColor, text_size=size.small)
        array.push(orderBlocks, bearOB)

// ==================== FAIR VALUE GAPS (FVG) ====================

bullishFVG = bar_index >= 2 and low > high[2] and close[1] > open[1]
fvgBullTop = low
fvgBullBottom = high[2]

bearishFVG = bar_index >= 2 and high < low[2] and close[1] < open[1]
fvgBearTop = low[2]
fvgBearBottom = high

// Draw FVGs
if showFVG
    if bullishFVG and barstate.isconfirmed
        fvgBox = box.new(bar_index - 2, fvgBullTop, bar_index + 20, fvgBullBottom,
                         bgcolor=fvgBullColor, border_color=color.new(color.aqua, 50),
                         border_width=1, text="FVG", text_size=size.tiny)
        array.push(fvgBoxes, fvgBox)
    
    if bearishFVG and barstate.isconfirmed
        fvgBox = box.new(bar_index - 2, fvgBearTop, bar_index + 20, fvgBearBottom,
                         bgcolor=fvgBearColor, border_color=color.new(color.orange, 50),
                         border_width=1, text="FVG", text_size=size.tiny)
        array.push(fvgBoxes, fvgBox)

// ==================== LIQUIDITY ZONES ====================

var float[] equalHighs = array.new<float>()
var int[] equalHighBars = array.new<int>()

if swingHigh
    if array.size(equalHighs) > 0
        for i = 0 to array.size(equalHighs) - 1
            if math.abs(high - array.get(equalHighs, i)) < (high * 0.001)
                if showLiquidity
                    line.new(array.get(equalHighBars, i), array.get(equalHighs, i),
                            bar_index, high, color=color.new(color.yellow, 50),
                            style=line.style_dashed, width=2)
                    label.new(bar_index, high, "Liquidity", style=label.style_label_down,
                             color=color.new(color.yellow, 30), textcolor=color.white, size=size.small)
    
    array.push(equalHighs, high)
    array.push(equalHighBars, bar_index)
    
    if array.size(equalHighs) > 10
        array.shift(equalHighs)
        array.shift(equalHighBars)

var float[] equalLows = array.new<float>()
var int[] equalLowBars = array.new<int>()

if swingLow
    if array.size(equalLows) > 0
        for i = 0 to array.size(equalLows) - 1
            if math.abs(low - array.get(equalLows, i)) < (low * 0.001)
                if showLiquidity
                    line.new(array.get(equalLowBars, i), array.get(equalLows, i),
                            bar_index, low, color=color.new(color.yellow, 50),
                            style=line.style_dashed, width=2)
                    label.new(bar_index, low, "Liquidity", style=label.style_label_up,
                             color=color.new(color.yellow, 30), textcolor=color.white, size=size.small)
    
    array.push(equalLows, low)
    array.push(equalLowBars, bar_index)
    
    if array.size(equalLows) > 10
        array.shift(equalLows)
        array.shift(equalLowBars)

// ==================== VOLUME ANALYSIS ====================

avgVolume = ta.sma(volume, 20)
volumeSpike = volume > avgVolume * volumeThreshold

buyVolume = close > open ? volume : 0.0
sellVolume = close < open ? volume : 0.0
volumeDelta = ta.sma(buyVolume - sellVolume, 10)

volumeAtResistance = volumeSpike and close >= high[1]
volumeAtSupport = volumeSpike and close <= low[1]

bgcolor(showDelta and volumeDelta > 0 ? color.new(color.green, 95) : showDelta and volumeDelta < 0 ? color.new(color.red, 95) : na)

// ==================== MOMENTUM INDICATORS ====================

rsi = ta.rsi(close, rsiLength)
rsiOverbought = rsi > 70
rsiOversold = rsi < 30
rsiDivergenceBull = rsi > rsi[1] and low < low[1]
rsiDivergenceBear = rsi < rsi[1] and high > high[1]

[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdCrossUp = ta.crossover(macdLine, signalLine)
macdCrossDown = ta.crossunder(macdLine, signalLine)
macdBullish = macdLine > signalLine and histLine > histLine[1]
macdBearish = macdLine < signalLine and histLine < histLine[1]

stochK = ta.stoch(close, high, low, 14)
stochD = ta.sma(stochK, 3)
stochOversold = stochK < 20 and stochD < 20
stochOverbought = stochK > 80 and stochD > 80

[diPlus, diMinus, adx] = ta.dmi(14, 14)
strongTrend = adx > 25
trendUp = diPlus > diMinus
trendDown = diMinus > diPlus

// ==================== CANDLESTICK PATTERNS ====================

bullishEngulfing = close > open and close[1] < open[1] and close > open[1] and open < close[1]
bearishEngulfing = close < open and close[1] > open[1] and close < open[1] and open > close[1]

bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
isHammer = lowerWick > bodySize * 2 and upperWick < bodySize * 0.5 and close > open
isShootingStar = upperWick > bodySize * 2 and lowerWick < bodySize * 0.5 and close < open

isDoji = bodySize < (high - low) * 0.1

morningStar = bar_index >= 2 and close[2] < open[2] and math.abs(close[1] - open[1]) < (high[1] - low[1]) * 0.3 and close > open and close > (high[2] + low[2]) / 2
eveningStar = bar_index >= 2 and close[2] > open[2] and math.abs(close[1] - open[1]) < (high[1] - low[1]) * 0.3 and close < open and close < (high[2] + low[2]) / 2

// ==================== MULTI-TIMEFRAME ANALYSIS ====================

htf1Close = request.security(syminfo.tickerid, htf1, close)
htf1Trend = htf1Close > ta.sma(htf1Close, 20)

htf2Close = request.security(syminfo.tickerid, htf2, close)
htf2Trend = htf2Close > ta.sma(htf2Close, 50)

htfBullish = htf1Trend and htf2Trend
htfBearish = not htf1Trend and not htf2Trend

// ==================== ADVANCED SIGNAL GENERATION ====================

var float bullScore = 0.0
var float bearScore = 0.0

bullScore := 0.0
bearScore := 0.0

if bullishBOS
    bullScore += 20
if bearishBOS
    bearScore += 20

[bullOBH, bullOBL, bullOBB, bullOBV] = detectBullishOB()
[bearOBH, bearOBL, bearOBB, bearOBV] = detectBearishOB()

if bullOBV
    bullScore += 15
if bearOBV
    bearScore += 15

if volumeDelta > 0 and volumeSpike
    bullScore += 15
if volumeDelta < 0 and volumeSpike
    bearScore += 15

if macdBullish and rsi > 50
    bullScore += 10
if macdBearish and rsi < 50
    bearScore += 10

if rsiDivergenceBull
    bullScore += 10
if rsiDivergenceBear
    bearScore += 10

if bullishEngulfing or isHammer or morningStar
    bullScore += 10
if bearishEngulfing or isShootingStar or eveningStar
    bearScore += 10

if multitimeframe and htfBullish
    bullScore += 10
if multitimeframe and htfBearish
    bearScore += 10

if strongTrend and trendUp
    bullScore += 10
if strongTrend and trendDown
    bearScore += 10

if bullishFVG
    bullScore += 10
if bearishFVG
    bearScore += 10

lowThreshold = 40
mediumThreshold = 60
highThreshold = 75

minScore = signalStrength == "Low" ? lowThreshold : signalStrength == "Medium" ? mediumThreshold : highThreshold

buySignal = bullScore >= minScore and bullScore > bearScore
sellSignal = bearScore >= minScore and bearScore > bullScore

signalQuality = buySignal and bullScore >= highThreshold ? "STRONG" : buySignal and bullScore >= mediumThreshold ? "MEDIUM" : buySignal ? "WEAK" : sellSignal and bearScore >= highThreshold ? "STRONG" : sellSignal and bearScore >= mediumThreshold ? "MEDIUM" : sellSignal ? "WEAK" : ""

// ==================== PLOTTING ====================

if showBuySignals and buySignal
    label.new(bar_index, low, text="BUY\n" + signalQuality + "\n" + str.tostring(math.round(bullScore)), style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.normal)
    if alertOnSignal
        alert("QUINT BUY - Score: " + str.tostring(math.round(bullScore)) + " - " + syminfo.ticker + " - " + timeframe.period, alert.freq_once_per_bar)

if showSellSignals and sellSignal
    label.new(bar_index, high, text="SELL\n" + signalQuality + "\n" + str.tostring(math.round(bearScore)), style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.normal)
    if alertOnSignal
        alert("QUINT SELL - Score: " + str.tostring(math.round(bearScore)) + " - " + syminfo.ticker + " - " + timeframe.period, alert.freq_once_per_bar)

plotshape(showBOS and bullishBOS, "Bullish BOS", shape.triangleup, location.belowbar, color.new(color.lime, 0), size=size.small, text="BOS")
plotshape(showBOS and bearishBOS, "Bearish BOS", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small, text="BOS")

plotshape(showCandles and bullishEngulfing, "Bull Engulf", shape.circle, location.belowbar, color.new(color.green, 30), size=size.tiny)
plotshape(showCandles and bearishEngulfing, "Bear Engulf", shape.circle, location.abovebar, color.new(color.red, 30), size=size.tiny)

plotshape(volumeSpike and close > open, "Volume Spike Up", shape.diamond, location.belowbar, color.new(color.green, 70), size=size.tiny)
plotshape(volumeSpike and close < open, "Volume Spike Down", shape.diamond, location.abovebar, color.new(color.red, 70), size=size.tiny)

trendColor = strongTrend and trendUp ? color.new(color.green, 97) : strongTrend and trendDown ? color.new(color.red, 97) : na
bgcolor(showMomentum ? trendColor : na)

// ==================== INFO TABLE ====================

var table infoTable = table.new(position.top_right, 3, 12, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "QUINT SYSTEM", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 70))
    table.merge_cells(infoTable, 0, 0, 2, 0)
    
    table.cell(infoTable, 0, 1, "Bull Score", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(math.round(bullScore)), text_color=bullScore >= minScore ? color.lime : color.gray, text_size=size.normal)
    table.cell(infoTable, 2, 1, bullScore >= highThreshold ? "FIRE" : bullScore >= mediumThreshold ? "BOLT" : "STAR", text_size=size.normal)
    
    table.cell(infoTable, 0, 2, "Bear Score", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(math.round(bearScore)), text_color=bearScore >= minScore ? color.red : color.gray, text_size=size.normal)
    table.cell(infoTable, 2, 2, bearScore >= highThreshold ? "FIRE" : bearScore >= mediumThreshold ? "BOLT" : "STAR", text_size=size.normal)
    
    table.cell(infoTable, 0, 3, "Trend", text_color=color.white, text_size=size.small)
    trendText = strongTrend and trendUp ? "BULLISH" : strongTrend and trendDown ? "BEARISH" : "NEUTRAL"
    trendColorTable = strongTrend and trendUp ? color.green : strongTrend and trendDown ? color.red : color.gray
    table.cell(infoTable, 1, 3, trendText, text_color=trendColorTable, text_size=size.small)
    table.cell(infoTable, 2, 3, "ADX: " + str.tostring(math.round(adx)), text_color=color.white, text_size=size.tiny)
    
    table.cell(infoTable, 0, 4, "RSI", text_color=color.white, text_size=size.small)
    rsiColor = rsiOverbought ? color.red : rsiOversold ? color.green : color.gray
    table.cell(infoTable, 1, 4, str.tostring(math.round(rsi)), text_color=rsiColor, text_size=size.small)
    table.cell(infoTable, 2, 4, rsiOverbought ? "OB" : rsiOversold ? "OS" : "OK", text_size=size.tiny)
    
    table.cell(infoTable, 0, 5, "MACD", text_color=color.white, text_size=size.small)
    macdStatus = macdBullish ? "BULL" : macdBearish ? "BEAR" : "NEUTRAL"
    macdColor = macdBullish ? color.green : macdBearish ? color.red : color.gray
    table.cell(infoTable, 1, 5, macdStatus, text_color=macdColor, text_size=size.small)
    table.cell(infoTable, 2, 5, macdCrossUp ? "UP" : macdCrossDown ? "DN" : "--", text_size=size.small)
    
    table.cell(infoTable, 0, 6, "Volume", text_color=color.white, text_size=size.small)
    volRatio = volume / avgVolume
    volColor = volRatio > volumeThreshold ? color.yellow : color.gray
    table.cell(infoTable, 1, 6, str.tostring(math.round(volRatio, 2)) + "x", text_color=volColor, text_size=size.small)
    table.cell(infoTable, 2, 6, volumeSpike ? "HIGH" : "--", text_size=size.small)
    
    table.cell(infoTable, 0, 7, "Delta", text_color=color.white, text_size=size.small)
    deltaColor = volumeDelta > 0 ? color.green : volumeDelta < 0 ? color.red : color.gray
    deltaText = volumeDelta > 0 ? "BUYING" : volumeDelta < 0 ? "SELLING" : "NEUTRAL"
    table.cell(infoTable, 1, 7, deltaText, text_color=deltaColor, text_size=size.small)
    table.cell(infoTable, 2, 7, volumeDelta > 0 ? "+" : volumeDelta < 0 ? "-" : "=", text_size=size.small)
    
    if multitimeframe
        table.cell(infoTable, 0, 8, "HTF Align", text_color=color.white, text_size=size.small)
        htfText = htfBullish ? "BULLISH" : htfBearish ? "BEARISH" : "MIXED"
        htfColor = htfBullish ? color.green : htfBearish ? color.red : color.gray
        table.cell(infoTable, 1, 8, htfText, text_color=htfColor, text_size=size.small)
        table.cell(infoTable, 2, 8, htfBullish ? "OK" : htfBearish ? "OK" : "X", text_size=size.small)
    
    table.cell(infoTable, 0, 9, "Structure", text_color=color.white, text_size=size.small)
    bosText = bullishBOS ? "BULL BOS" : bearishBOS ? "BEAR BOS" : "RANGE"
    bosColor = bullishBOS ? color.green : bearishBOS ? color.red : color.gray
    table.cell(infoTable, 1, 9, bosText, text_color=bosColor, text_size=size.small)
    table.cell(infoTable, 2, 9, bullishBOS ? "UP" : bearishBOS ? "DN" : "--", text_size=size.small)
    
    table.cell(infoTable, 0, 10, "Timeframe", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 10, timeframe.period, text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 2, 10, "TF", text_size=size.small)
    
    table.cell(infoTable, 0, 11, "Status", text_color=color.white, text_size=size.small)
    statusText = buySignal ? "BUY" : sellSignal ? "SELL" : "NEUTRAL"
    statusColor = buySignal ? color.green : sellSignal ? color.red : color.gray
    table.cell(infoTable, 1, 11, statusText, text_color=statusColor, text_size=size.normal)
    table.merge_cells(infoTable, 1, 11, 2, 11)

if barstate.islast
    clearOldDrawings()

plot(rsi, "RSI", color=color.new(color.purple, 0), display=display.none)
plot(adx, "ADX", color=color.new(color.orange, 0), display=display.none)
hline(70, "OB", color=color.new(color.red, 50), linestyle=hline.style_dashed, display=display.none)
hline(30, "OS", color=color.new(color.green, 50), linestyle=hline.style_dashed, display=display.none)
